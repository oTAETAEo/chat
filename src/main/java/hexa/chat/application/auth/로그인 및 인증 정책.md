# 로그인 및 인증 정책 (Auth Policy)

---

## 1. 로그인 프로세스 정책
- **식별자 (Identity)**: `이메일(email)`을 고유 식별자로 사용한다.
- **인증 방식 (Authentication)**: 비밀번호 검증을 통해 사용자를 인증한다.
- **실패 처리 (Failure Handling)**: 
  - 존재하지 않는 이메일이거나 비밀번호가 일치하지 않을 경우, 보안을 위해 "아이디 또는 비밀번호가 올바르지 않습니다"라는 일반적인 메시지를 사용한다.
  - 구체적인 에러 원인(이메일 불일치 vs 비밀번호 불일치)은 외부에 노출하지 않는다.
- **성공 처리 (Success Handling)**: 인증 성공 시 **Access Token**과 **Refresh Token** 쌍을 발급한다.

---

## 2. 토큰 관리 정책 (Token Policy)

### 액세스 토큰 (Access Token)
- **용도**: 일반 API 요청 시 본인 인증 및 인가용.
- **포함 정보 (Payload)**: 
  - `sub` (Subject): 공개 식별자 (`member.publicId`) - 보안을 위해 내부 PK 대신 사용
  - `role`: 회원 권한 정보 (예: `ROLE_USER`)
  - `iat` (Issued At): 발급 시간
  - `exp` (Expiration Time): 만료 시간
- **유효 기간**: **30분** (보안을 위해 짧게 유지).
- **데이터 일관성**: 이메일, 닉네임 등 변경 가능한 정보는 토큰에 포함하지 않는다. (실시간 채팅 특성상 별도 API/소켓으로 관리)
- **클라이언트 저장**: 앱 메모리 또는 클라이언트 보안 저장소. API 요청 시 `Authorization: Bearer {Token}` 헤더에 포함.

### 리프레시 토큰 (Refresh Token) - **멀티 디바이스 지원**
- **용도**: 액세스 토큰 만료 시 재발급을 통한 로그인 상태 유지.
- **포함 정보 (Payload)**: 
  - `sub` (Subject): 공개 식별자 (`member.publicId`)
  - `deviceId`: 기기 식별자 (또는 User-Agent 해시)
  - `exp` (Expiration Time): 만료 시간
- **유효 기간**: **2주** (사용자 편의를 위해 길게 유지).
- **멀티 디바이스 정책**:
  - **1:N 관계**: 한 명의 회원은 여러 대의 기기(PC, 모바일, 태블릿 등)에서 동시에 로그인 상태를 유지할 수 있다.
  - **식별**: 서버는 `{memberId, deviceId(또는 User-Agent)}` 조합으로 각 기기의 리프레시 토큰을 구분하여 저장한다.
- **서버 측 관리**: 
  - 서버 저장소(DB 또는 Redis)에 화이트리스트 방식으로 저장하여 관리한다.
  - 재발급 시 클라이언트의 토큰과 서버에 저장된 토큰이 일치하는지 검증한다.
- **클라이언트 측 관리**: 
  - 웹 환경에서는 XSS 공격 방지를 위해 **HttpOnly 및 Secure 쿠키** 사용을 권장한다.
- **만료 및 삭제**: 
  - 사용자가 로그아웃 시 해당 기기에 할당된 리프레시 토큰만 삭제한다.
  - 비밀번호 변경 시 보안을 위해 해당 회원의 모든 리프레시 토큰을 무효화(삭제)하는 것을 고려한다.

---

## 3. 비밀번호 보안 정책
- **암호화**: 비밀번호는 반드시 단방향 해시 함수(BCrypt 등)를 사용하여 암호화된 `passwordHash` 상태로 저장한다.
- **검증**: 로그인 시 입력된 평문 비밀번호와 DB의 해시값을 비교(`matches`)한다. 평문 비밀번호는 절대 로그에 남기거나 DB에 저장하지 않는다.

---

## 4. 확장성 및 고려사항
- **OAuth2 지원**: 향후 소셜 로그인 확장을 위해 `LoginUseCase` 인터페이스를 통해 다양한 인증 수단을 수용할 수 있도록 설계한다.
- **토큰 로테이션 (Rotation)**: 보안 강화를 위해 액세스 토큰 재발급 시 리프레시 토큰도 함께 갱신하는 정책을 추후 검토할 수 있다.